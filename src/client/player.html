<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Roaming: Player Viewer</title>
  <meta name="viewport" content="initial-scale=1">
  <link rel="stylesheet" href="./css/core.css" type="text/css">
  <link rel="stylesheet" href="./css/listing.css" type="text/css">
  <link rel="stylesheet" href="./css/layout.css" type="text/css">
  <style>
    h1 {
      margin: 0;
      padding: 12px;
      font-size: 1.4em;
      color: #eee;
    }
    #main {
      overflow: auto;
    }
    .item .field-id {

    }
    .where {
      position: absolute;
      top: 2px; right: 2px;
      background-color: #060;
      color: #fff;
      padding: 2px 6px;
      font-size: smaller;
    }
  </style>
</head>
<body>
<section id="hud" class="panel">
  <span class="where" data-bind="text: position"></span>
  <div id="playerInfo">
  </div>
</section>
<section id="main" class="panel">
  <h2>Inventory</h2>
  <script type="text/notes">
    fill this element with rendered items from the inventory collection
  </script>
  <ul id="inventory">
  </ul>
  <h2>Visits</h2>
  <ul id="visits">
  </ul>
  <h2>Here</h2>
  <ul id="hereItems">
  </ul>
</section>

<script type="text/template" id="itemTemplate">
  <li class="item {equipped}">{name}</li>
</script>
<script type="text/template" id="visitTemplate">
  <li data-itemid="{index}">
    <span>{id}</span>
    <span>{timestamp}</span>
  </li>
</script>

<script src="./vendor/require.js"></script>
<script src="./config.js"></script>
<script>
  require([
    'resources/template',
    'lib/util',
    'resources/player',
    'resources/item',
    'plugins/vendor/json!player/'+(config.playerid || 'guest') + '.json',
    'text!resources/templates/player.html',
    'resources/weapons',
    'resources/items',
    'plugins/resource!resources/items#hagStone',
  ], function(template, util, Player, Item, playerData, playerTemplate,
              weapons, items, hagStone){

    window.player = playerData = Player.fillDefaults(playerData);
    window.tile = {};
    var hereItems = tile.here = [
      hagStone
    ];

    var viewModel = window.viewModel = {
      player: playerData,
      here: hereItems
    };

    // player entity is all data
    // but we need to resolve references to things like weapon, inventory items

    // getPlayerInventory()
    // getPlayerWeapon()
    // getPlayerStats()

    //
    // render player stats
    // render player icon
    // get player inventory
    //    and render each item
    // get player history
    //    and render each item
    // render player current weapon

    var hud = {
      init: function() {
        this.element = document.getElementById('hud');
        this.registerEvents();
        this.updatePlayerInfo(player);
      },
      registerEvents: function() {

      },
      handleEvent: function(evt) {

      },
      updatePlayerInfo: function(player) {
        var container = document.getElementById('playerInfo');
        var infoTemplate = template(playerTemplate);
        container.innerHTML = infoTemplate(player);
      }
    };

    function createTemplateFromScriptNode(node) {
      return template(node.innerHTML);
    }
    var mainUI = {
      init: function() {

        this.element = document.getElementById('main');
        this.registerEvents();
        this.updateInventory(player.inventory);
        // this.updateVisits(player.visits);
        this.updateHereItems(tile.here);
      },
      registerEvents: function() {

      },
      handleEvent: function(evt) {

      },
      updateInventory: function(inventory) {
        var itemTemplate = createTemplateFromScriptNode(
          document.getElementById('itemTemplate')
        );
        var container = document.getElementById('inventory');
        var itemHTMLs = inventory.map(function(item) {
          console.log('inventory item: ', item);
          item = Item.fillDefaults(item);
          return itemTemplate(util.create(item, {
                  equipped: item.equipped ? 'equipped' : '' }));
        });
        container.innerHTML = itemHTMLs.join('\n');
      },
      updateVisits: function(visits) {
        var itemTemplate = createTemplateFromScriptNode(
          document.getElementById('visitTemplate')
        );
        var container = document.getElementById('visits');
        var itemHTMLs = visits.map(function(item, index) {
          return itemTemplate(util.create(item, {
            index: index
          }));
        });
        container.innerHTML = itemHTMLs.join('\n');
      },
      updateHereItems: function(items) {
        var itemTemplate = createTemplateFromScriptNode(
          document.getElementById('itemTemplate')
        );
        var container = document.getElementById('hereItems');
        var itemHTMLs = items.map(function(item, index) {
          console.log('item: ', item)
          var html = itemTemplate(util.create(item, {
            equipped: false,
            index: index
          }));
          return html;
        });
        container.innerHTML = itemHTMLs.join('\n');
      }
    };

    hud.init();
    mainUI.init();

    // viewModel.here.subscribe(function(change){
    //   tile.here = ko.mapping.toJS(viewModel.here);
    //   console.log("tile.here: ", tile.here);
    // });

    // viewModel.player.inventory.subscribe(function(newValue){
    //   player.inventory = ko.mapping.toJS(viewModel.player.inventory);
    //   console.log("inventory change: ", player.inventory);
    // });
  });
</script>
</body>
</html>